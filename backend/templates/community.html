{% extends "base.html" %}

{% block title %}C·ªông ƒë·ªìng - CareerGo{% endblock %}

{% block loading_text %}ƒêang t·∫£i...{% endblock %}

{% block content %}
<section class="page active" id="community">
    <!-- Top Bar: Journey Stepper (Like Stories/Header) -->
    <div class="panel community-top-panel">
        <h1 class="section-title community-top-title">C·ªông ƒë·ªìng CareerGo</h1>
        <div class="journey-stepper" aria-label="H√†nh tr√¨nh h∆∞·ªõng nghi·ªáp">
            <div class="journey-step" data-page="test" role="button" tabindex="0"><span class="step-dot">1</span><span>Tr·∫Øc nghi·ªám</span></div>
            <div class="journey-step" data-page="results" role="button" tabindex="0"><span class="step-dot">2</span><span>K·∫øt qu·∫£</span></div>
            <div class="journey-step" data-page="vr-mode" role="button" tabindex="0"><span class="step-dot">3</span><span>VR</span></div>
            <div class="journey-step" data-page="chatbot" role="button" tabindex="0"><span class="step-dot">4</span><span>AI Chat</span></div>
            <div class="journey-step active" aria-current="step"><span class="step-dot">5</span><span>C·ªông ƒë·ªìng</span></div>
        </div>
    </div>

    <div class="community-wrapper">
        
        <!-- LEFT COLUMN: Navigation & Metrics -->
        <aside class="comm-sidebar-left">
            <!-- Navigation Menu -->
            <div class="panel panel-soft community-side-nav-panel">
                <button type="button" class="sidebar-menu-item active"
                    data-community-mode="discover"
                    aria-pressed="true" onclick="setCommunityExploreMode('discover')">
                    <span class="sidebar-icon">üì∞</span>
                    <span>B·∫£ng tin</span>
                </button>
                <button type="button" class="sidebar-menu-item"
                    data-community-mode="rag"
                    aria-pressed="false" onclick="setCommunityExploreMode('rag')">
                    <span class="sidebar-icon">ü§ñ</span>
                    <span>H·ªèi AI C·ªông ƒë·ªìng</span>
                </button>
                <button type="button" class="sidebar-menu-item" onclick="goPage('chatbot')">
                    <span class="sidebar-icon">üí¨</span>
                    <span>AI Mentor</span>
                </button>
                <button type="button" class="sidebar-menu-item" onclick="goPage('results')">
                    <span class="sidebar-icon">üìä</span>
                    <span>H·ªì s∆° c·ªßa t√¥i</span>
                </button>
            </div>

            <!-- Community Metrics -->
            <div id="communityMetricsPanel" class="panel panel-soft community-metrics-side-panel">
                <div class="community-metrics-head">
                    <h3>Ch·ªâ s·ªë s√¥i ƒë·ªông</h3>
                </div>
                <div id="communityMetricsGrid" class="community-metrics-grid">
                    <div class="muted">ƒêang t·∫£i ch·ªâ s·ªë...</div>
                </div>
            </div>
        </aside>

        <!-- CENTER COLUMN: Feed & Composer -->
        <main class="comm-feed">
            <!-- 1. The Composer (Facebook Style) -->
            <div id="communityCreateSection" class="panel community-composer-panel">
                <div class="fb-composer-trigger" onclick="openCommunityComposerModal()">
                    <div class="fb-input-fake">B·∫°n ƒëang nghƒ© g√¨ v·ªÅ ƒë·ªãnh h∆∞·ªõng ngh·ªÅ nghi·ªáp?</div>
                </div>
                <div class="community-composer-actions-row">
                    <button class="btn btn-secondary community-composer-action-btn" onclick="openCommunityComposerModal()">
                        ‚úçÔ∏è T·∫°o b√†i vi·∫øt m·ªõi
                    </button>
                </div>
            </div>
            <div id="communityComposerQuickStatus" class="status" role="status" aria-live="polite"></div>

            <div class="community-mode-switch community-mode-switch-inline" role="tablist" aria-label="Ch·∫ø ƒë·ªô c·ªông ƒë·ªìng">
                <button id="communityModeDiscover" type="button" class="btn btn-secondary active"
                    data-community-mode="discover"
                    aria-pressed="true" onclick="setCommunityExploreMode('discover')">Kh√°m ph√° th·∫£o lu·∫≠n</button>
                <button id="communityModeRag" type="button" class="btn btn-secondary"
                    data-community-mode="rag"
                    aria-pressed="false" onclick="setCommunityExploreMode('rag')">H·ªèi ƒë√°p c·ªông ƒë·ªìng (RAG)</button>
            </div>

            <!-- 2. RAG/Search Section (Hidden/Shown based on tab) -->
            <div id="communityRagModePanel" class="panel panel-soft community-rag-panel" role="region" aria-label="Ch·∫ø ƒë·ªô h·ªèi ƒë√°p c·ªông ƒë·ªìng" hidden>
                <h3>H·ªèi ƒë√°p RAG</h3>
                <p class="helper-text">AI s·∫Ω t√¨m c√¢u tr·∫£ l·ªùi t·ª´ c√°c th·∫£o lu·∫≠n c≈©.</p>
                <div class="community-rag-row">
                    <input id="communityRagQuestion" class="community-input" type="text"
                        placeholder="V√≠ d·ª•: Em l·ªõp 12 n√™n ∆∞u ti√™n k·ªπ nƒÉng n√†o ƒë·ªÉ theo ng√†nh CNTT?">
                    <button class="btn btn-primary" onclick="askCommunityRag()">H·ªèi</button>
                </div>
                <div id="communityRagStatus" class="status" role="status" aria-live="polite"></div>
                <div id="communityRagAnswer" class="community-rag-answer muted">Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi.</div>
                <div id="communityRagCitations" class="community-suggest-grid">
                    <div class="muted">Ngu·ªìn tr√≠ch d·∫´n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</div>
                </div>
            </div>

            <!-- 3. Feed Filters & Controls -->
            <div id="communityDiscoverModePanel" class="panel panel-soft community-discover-panel">
                <div class="fb-filters">
                    <strong class="community-filter-title">B√†i vi·∫øt</strong>
                    <div class="community-filter-controls">
                        <select id="communityCategoryFilter" class="community-input community-filter-select"
                            onchange="changeCommunityCategoryFilter(this.value)">
                            <option value="all">T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
                            <option value="general">Chung</option>
                            <option value="major">Ng√†nh h·ªçc</option>
                            <option value="skills">K·ªπ nƒÉng</option>
                            <option value="admissions">Tuy·ªÉn sinh</option>
                        </select>
                        <select id="communitySort" class="community-input community-filter-select" onchange="changeCommunitySort(this.value)">
                            <option value="newest">M·ªõi nh·∫•t</option>
                            <option value="most_commented">N·ªïi b·∫≠t</option>
                        </select>
                    </div>
                </div>
                <!-- Search Bar hidden inside filter panel -->
                <div class="community-search-wrap">
                    <input id="communitySearch" class="community-input community-search-input" type="text"
                    placeholder="üîç T√¨m ki·∫øm b√†i vi·∫øt..." oninput="changeCommunitySearch(this.value)">
                </div>
            </div>

            <!-- 4. Posts Stream -->
            <p id="communityFeedSummary" class="muted">ƒêang t·∫£i d·ªØ li·ªáu b·∫£ng tin...</p>
            <div id="postsContainer" class="posts-container community-posts-stream" aria-live="polite">
                <div class="spinner community-feed-spinner"></div>
            </div>

            <!-- Pagination -->
            <div id="communityPagination" class="panel panel-soft community-pagination-panel" aria-live="polite">
                <div id="communityPaginationSummary" class="muted">ƒêang t·∫£i ph√¢n trang...</div>
                <div class="community-pagination-actions community-pagination-actions-gap">
                    <button id="communityPrevPageBtn" class="btn btn-secondary" onclick="goCommunityPrevPage()">Trang tr∆∞·ªõc</button>
                    <button id="communityNextPageBtn" class="btn btn-secondary" onclick="goCommunityNextPage()">Trang sau</button>
                </div>
            </div>
        </main>

        <!-- RIGHT COLUMN: Widgets & Extras -->
        <aside class="comm-sidebar-right">
            <!-- Related Posts (Sticky-ish) -->
            <div class="community-related-block panel panel-soft community-side-block">
                <h4>C√≥ th·ªÉ b·∫°n quan t√¢m</h4>
                <p id="communityViewingRelatedHint" class="helper-text">Ch·ªçn "Li√™n quan" tr√™n m·ªôt b√†i vi·∫øt ƒë·ªÉ xem.</p>
                <div id="communityViewingRelated" class="community-suggest-grid">
                    <div class="muted">Ch∆∞a ch·ªçn b√†i vi·∫øt.</div>
                </div>
            </div>

            <!-- Admin Panel (Only shows if admin) -->
            <div id="communityAdminReports" class="admin-only panel panel-soft community-admin-zone">
                <h4>üõ°Ô∏è Admin Zone</h4>
                <p class="helper-text">B√°o c√°o g·∫ßn ƒë√¢y.</p>
                <div id="communityAdminReportsStatus" class="status"></div>
                <div id="communityAdminReportsList" class="community-reports-list muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
            </div>

            <!-- Next Step Card -->
            <div class="journey-next panel community-next-card">
                <strong>B∆∞·ªõc ti·∫øp theo</strong>
                <p class="muted community-next-hint">Sau khi tham kh·∫£o c·ªông ƒë·ªìng, h√£y quay l·∫°i AI ƒë·ªÉ ch·ªët k·∫ø ho·∫°ch.</p>
                <button class="btn btn-primary w-100 community-next-btn" onclick="goPage('chatbot')">Quay l·∫°i AI Chat</button>
            </div>
        </aside>

    </div> <!-- End Grid Wrapper -->
</section>
{% endblock %}

{% block modals %}
<!-- Modals kept exactly same as original functionality -->
<div id="communityReportModal" class="loading-overlay" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="communityReportTitle"
    tabindex="-1">
    <div class="loading-modal panel report-modal-card">
        <h2 id="communityReportTitle" class="section-title report-modal-title">B√°o c√°o n·ªôi dung</h2>
        <p id="communityReportTarget" class="muted report-modal-target"></p>
        <div class="field">
            <label for="communityReportReason">L√Ω do b√°o c√°o</label>
            <select id="communityReportReason" class="community-input">
                <option value="spam">Spam / qu·∫£ng c√°o</option>
                <option value="abuse">Ng√¥n t·ª´ x√∫c ph·∫°m</option>
                <option value="misinformation">Th√¥ng tin sai l·ªách</option>
                <option value="offtopic">Kh√¥ng li√™n quan ch·ªß ƒë·ªÅ</option>
                <option value="other">Kh√°c</option>
            </select>
        </div>
        <div class="field">
            <label for="communityReportDetail">M√¥ t·∫£ th√™m (tu·ª≥ ch·ªçn)</label>
            <textarea id="communityReportDetail" class="community-input" rows="3" maxlength="300"
                placeholder="M√¥ t·∫£ ng·∫Øn ƒë·ªÉ Admin x·ª≠ l√Ω nhanh h∆°n..."></textarea>
        </div>
        <div class="center-actions report-modal-actions">
            <button class="btn btn-secondary" onclick="closeCommunityReportModal()">H·ªßy</button>
            <button class="btn btn-primary" onclick="submitCommunityReport()">G·ª≠i b√°o c√°o</button>
        </div>
        <div id="communityReportStatus" class="status" role="status" aria-live="polite"></div>
    </div>
</div>

<div id="communityComposerModal" class="loading-overlay" role="dialog" aria-modal="true" aria-hidden="true"
    aria-labelledby="communityComposerTitle" tabindex="-1">
    <div class="loading-modal panel community-compose-modal-card">
        <div class="community-compose-head">
            <h2 id="communityComposerTitle" class="section-title">T·∫°o b√†i vi·∫øt m·ªõi</h2>
            <button type="button" class="icon-btn" onclick="closeCommunityComposerModal()" aria-label="ƒê√≥ng c·ª≠a s·ªï so·∫°n b√†i">&times;</button>
        </div>
        <div class="community-write-guide">
            <p class="helper-text">G·ª£i √Ω vi·∫øt b√†i t·ªët: n√™u r√µ l·ªõp/ng√†nh quan t√¢m, v·∫•n ƒë·ªÅ b·∫°n ƒëang g·∫∑p v√† m·ª•c ti√™u b·∫°n mu·ªën ƒë·∫°t.</p>
        </div>
        <input type="text" id="postTitle" placeholder="Ti√™u ƒë·ªÅ b√†i vi·∫øt..." class="community-input" maxlength="100">
        <p class="helper-text">Ti√™u ƒë·ªÅ ng·∫Øn g·ªçn, r√µ v·∫•n ƒë·ªÅ (v√≠ d·ª•: ‚ÄúN√™n ch·ªçn CNTT hay Thi·∫øt k·∫ø ƒë·ªì h·ªça?‚Äù).</p>
        <select id="postCategory" class="community-input community-category-select">
            <option value="general">Chung</option>
            <option value="major">Ng√†nh h·ªçc</option>
            <option value="skills">K·ªπ nƒÉng</option>
            <option value="admissions">Tuy·ªÉn sinh</option>
            <option value="study">Kinh nghi·ªám h·ªçc t·∫≠p</option>
            <option value="mindset">T√¢m l√Ω</option>
        </select>
        <p class="helper-text">Ch·ªçn ƒë√∫ng ch·ªß ƒë·ªÅ ƒë·ªÉ b√†i vi·∫øt d·ªÖ ƒë∆∞·ª£c ph·∫£n h·ªìi b·ªüi ƒë√∫ng ng∆∞·ªùi.</p>
        <input type="text" id="postAuthor" placeholder="T√™n c·ªßa b·∫°n (ho·∫∑c nickname)..." class="community-input">
        <p id="postAuthorHelp" class="helper-text"></p>
        <textarea id="postContent" rows="4" placeholder="B·∫°n ƒëang nghƒ© g√¨? H√£y chia s·∫ª th·∫Øc m·∫Øc ho·∫∑c √Ω t∆∞·ªüng..."
            class="community-input"></textarea>
        <p class="helper-text">M√¥ t·∫£ c·ª• th·ªÉ ho√†n c·∫£nh c·ªßa b·∫°n ƒë·ªÉ c·ªông ƒë·ªìng ƒë∆∞a l·ªùi khuy√™n ch√≠nh x√°c h∆°n.</p>
        <p id="communityDraftSaveStatus" class="muted">Nh√°p b√†i vi·∫øt ch∆∞a ƒë∆∞·ª£c l∆∞u.</p>
        <div class="community-related-block">
            <h4>B√†i vi·∫øt li√™n quan khi b·∫°n ƒëang so·∫°n</h4>
            <div id="communityDraftRelated" class="community-suggest-grid">
                <div class="muted">Nh·∫≠p ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung ƒë·ªÉ xem g·ª£i √Ω li√™n quan.</div>
            </div>
        </div>
        <div class="center-actions report-modal-actions">
            <button class="btn btn-secondary" onclick="closeCommunityComposerModal()">H·ªßy</button>
            <button class="btn btn-primary" onclick="createPost()">ƒêƒÉng b√†i</button>
        </div>
        <div id="communityStatus" class="status" role="status" aria-live="polite"></div>
    </div>
</div>

<div id="communityPostDetailModal" class="loading-overlay" role="dialog" aria-modal="true" aria-hidden="true"
    aria-labelledby="communityPostDetailTitle" tabindex="-1">
    <div class="loading-modal panel community-post-detail-card">
        <div class="community-compose-head">
            <h2 id="communityPostDetailTitle" class="section-title">Chi ti·∫øt b√†i vi·∫øt</h2>
            <button type="button" class="icon-btn" onclick="closeCommunityPostDetailModal()" aria-label="ƒê√≥ng chi ti·∫øt b√†i vi·∫øt">&times;</button>
        </div>
        <div id="communityPostDetailBody" class="community-post-detail-body">
            <div class="muted">ƒêang t·∫£i chi ti·∫øt b√†i vi·∫øt...</div>
        </div>
        <div id="communityPostDetailStatus" class="status" role="status" aria-live="polite"></div>
    </div>
</div>
{% endblock %}
